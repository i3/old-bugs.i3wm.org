<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #745 (Tray Icons Disappearing on i3bar)
     – i3 window manager
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="/report/search" />
        <link rel="prev" href="/report/ticket/744" title="Ticket #744" />
        <link rel="last" href="/report/ticket/1444" title="Ticket #1444" />
        <link rel="help" href="/report/wiki/TracGuide" />
        <link rel="alternate" href="/report/ticket/745?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="/report/ticket/745?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="/report/ticket/745?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="/report/ticket/746" title="Ticket #746" />
        <link rel="start" href="/report/wiki" />
        <link rel="stylesheet" href="/report/chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="/report/chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="/report/ticket/1" title="Ticket #1" />
        <link rel="shortcut icon" href="/report/chrome/common/favicon.png" type="image/png" />
        <link rel="icon" href="/report/chrome/common/favicon.png" type="image/png" />
      <link type="application/opensearchdescription+xml" rel="search" href="/report/search/opensearch" title="Search i3 window manager" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="8f8f7a4906751bf29c839026";
      var comments_prefs={"comments_only":"false","comments_order":"oldest"};
    </script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/jquery.js"></script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/babel.js"></script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/trac.js"></script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/search.js"></script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/folding.js"></script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/wikitoolbar.js"></script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/resizer.js"></script>
      <script type="text/javascript" charset="utf-8" src="/report/chrome/common/js/auto_preview.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $(".trac-autofocus").focus();
        $(".trac-target-new").attr("target", "_blank");
        setTimeout(function() { $(".trac-scroll").scrollToTop() }, 1);
        $(".trac-disable-on-submit").disableOnSubmit();
      });
    </script>
    <script type="text/javascript" src="/report/chrome/common/js/threaded_comments.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
      /*<![CDATA[*/
        $("#attachments").toggleClass("collapsed");
        $("#trac-up-attachments").click(function () {
          $("#attachments").removeClass("collapsed");
          return true;
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
        function setRevertHandler() {
          $("button.trac-revert").click(function() {
            var div = $("div", this);
            var field_name = div[0].id.substr(7);
            var field_value = div.text();
            var input = $("#propertyform *[name=field_" + field_name + "]");
            if (input.length > 0) {
              if (input.filter("input[type=radio]").length > 0) {
                input.val([field_value]);
              } else if (input.filter("input[type=checkbox]").length > 0) {
                input.val(field_value == "1" ? [field_value] : []);
              } else {
                input.val(field_value);
              }
            } else { // Special case for CC checkbox
              input = $("#propertyform input[name=cc_update]").val([]);
            }
            input.change();
            $(this).closest("li").remove();
            return false;
          });
        }
        setRevertHandler();
        var comment_focused = false;
        $("#comment").focus(function() { comment_focused = true; })
                     .blur(function() { comment_focused = false; });
        $("#propertyform").autoSubmit({preview: '1'}, function(data, reply) {
          var items = $(reply);
          // Update ticket box
          $("#ticket").replaceWith(items.filter('#ticket'));
          // Unthread, unrevert and update changelog
          if (!$('#trac-comments-oldest').checked())
            $('#trac-comments-oldest').click().change();
          $("#changelog").replaceWith(items.filter("#changelog"));
          if ($('#trac-comments-only-toggle').attr('checked'))
            $('#trac-comments-only-toggle').click().attr('checked', true);
          // Show warning
          var new_changes = $("#changelog .trac-new");
          $("#trac-edit-warning").toggle(new_changes.length != 0);
          if (new_changes.length != 0)
            $("#changelog").parent().show().removeClass("collapsed");
          // Update view time
          $("#propertyform input[name='view_time']").replaceWith(items.filter("input[name='view_time']"));
          // Update preview
          var preview = $("#ticketchange").html(items.filter('#preview').children());
          var show_preview = preview.children().length != 0;
          $("#ticketchange").toggle(show_preview);
          setRevertHandler();
          // Collapse property form if comment editor has focus
          if (show_preview && comment_focused)
            $("#modify").parent().addClass("collapsed");
        }, "#ticketchange .trac-loading");
        $("#trac-comment-editor").autoSubmit({preview_comment: '1'}, function(data, reply) {
          var comment = $("#trac-comment-editor").next("div.comment").html(reply);
          comment.toggle(comment.children().length != 0);
        }, "#changelog .trac-loading");
        /*]]>*/
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="/report/wiki/TracIni#header_logo-section"><img src="/chrome/common/logo_bugs.png" alt="(i3 logo)" height="62" width="65" /></a>
      </div>
      <form id="search" action="/report/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/report/login">Login</a></li><li><a href="/report/prefs">Preferences</a></li><li class="last"><a href="/report/about">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="/report/timeline">Timeline</a></li><li class="active"><a href="/report/report">View Tickets</a></li><li class="last"><a href="/report/search">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
        <ul>
          <li class="first"><span>&larr; <a class="prev" href="/report/ticket/744" title="Ticket #744">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="/report/ticket/746" title="Ticket #746">Next Ticket</a> &rarr;</span></li>
        </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
        <div id="ticket" class="trac-content ">
  <div class="date">
    <p>Opened <a class="timeline" href="/report/timeline?from=2012-07-03T12%3A19%3A32%2B02%3A00&amp;precision=second" title="See timeline at 07/03/12 12:19:32">3 years ago</a></p>
    <p>Closed <a class="timeline" href="/report/timeline?from=2013-01-02T23%3A15%3A40%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 23:15:40">2 years ago</a></p>
    <p>Last modified <a class="timeline" href="/report/timeline?from=2013-01-02T23%3A46%3A54%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 23:46:54">2 years ago</a></p>
  </div>
  <h2>
    <a href="/report/ticket/745" class="trac-id">#745</a>
    <span class="trac-status">
      <a href="/report/query?status=closed">closed</a>
    </span>
    <span class="trac-type">
      <a href="/report/query?status=!closed&amp;type=defect">defect</a>
    </span>
    <span class="trac-resolution">
      (<a href="/report/query?status=closed&amp;resolution=fixed">fixed</a>)
    </span>
  </h2>
  <h1 id="trac-ticket-title" class="searchable">
    <span class="summary">Tray Icons Disappearing on i3bar</span>
  </h1>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">Bruno BRAGA &lt;bruno.braga@…&gt;</td>
      <th id="h_owner" class="missing">Owned by:</th>
      <td headers="h_owner"></td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="/report/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/report/query?status=!closed&amp;component=i3bar">i3bar</a>
        </td>
    </tr><tr>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/report/query?status=!closed&amp;version=4.2">4.2</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
              <a href="/report/query?status=!closed&amp;keywords=~icons">icons</a>
        </td>
    </tr><tr>
        <th id="h_cc" class="missing">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_reprod">
          Is it reproducible?:
        </th>
        <td headers="h_reprod">
              <a href="/report/query?status=!closed&amp;reprod=Always">Always</a>
        </td>
    </tr><tr>
        <th id="h_gitversion" class="missing">
          git version:
        </th>
        <td headers="h_gitversion">
        </td>
        <th id="h_os">
          Operating system:
        </th>
        <td headers="h_os">
              <a href="/report/query?status=!closed&amp;os=Linux">Linux</a>
        </td>
    </tr><tr>
        <th id="h_app">
          X11 program:
        </th>
        <td headers="h_app">
              lightdm
        </td>
        <th id="h_distri">
          Distribution / flavor:
        </th>
        <td headers="h_distri">
              Ubuntu 12.04
        </td>
    </tr><tr>
        <th id="h_ircnick">
          Your IRC nick:
        </th>
        <td headers="h_ircnick">
              bruno.braga
        </td>
        <th class="missing">
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
I am experiencing this annoying behaviour for some icons in the tray bar. They sometimes disappear out of nowhere, sometimes after coming back from suspend, or when I reload the i3 config (by hitting Mod+Shift+R). <br />
</p>
<p>
It always happens with checkgmail/xchat icons, but intermittently with Skype as well.<br />
</p>
<p>
I tried to check the logs, but there was nothing there. Even though the icons are gone, the applications are still running.<br />
</p>
<p>
More details of this are discussed in the mailing list:<br />
<a class="ext-link" href="http://infra.in.zekjur.net/archives/i3-discuss/2012-June/000745.html"><span class="icon">​</span>http://infra.in.zekjur.net/archives/i3-discuss/2012-June/000745.html</a><br />
</p>
<p>
From the logs, it looks like the problem from the mailing list:<br />
</p>
<pre class="wiki">[src/xcb.c:445] ERROR: Window 022002d7 violates the XEMBED protocol, _XEMBED_INFO not set
</pre><p>
(complete log is attached).<br />
</p>

    </div>
  </div>
</div>
          
    <div id="attachments">
        <h3 class="foldable">Attachments <span class="trac-count">(2)</span></h3>
        <div class="attachments">
          <dl class="attachments">
              <dt>
    <a href="/report/attachment/ticket/745/i3log-2012-07-03-20-02-07.tar.gz" title="View attachment">i3log-2012-07-03-20-02-07.tar.gz</a><a href="/report/raw-attachment/ticket/745/i3log-2012-07-03-20-02-07.tar.gz" class="trac-rawlink" title="Download">​</a>
       (<span title="8768 bytes">8.6 KB</span>) -
      added by <em>Bruno BRAGA &lt;bruno.braga@…&gt;</em> <a class="timeline" href="/report/timeline?from=2012-07-03T12%3A19%3A49%2B02%3A00&amp;precision=second" title="See timeline at 07/03/12 12:19:49">3 years ago</a>.
  </dt>
              <dt>
    <a href="/report/attachment/ticket/745/745.patch" title="View attachment">745.patch</a><a href="/report/raw-attachment/ticket/745/745.patch" class="trac-rawlink" title="Download">​</a>
       (<span title="3636 bytes">3.6 KB</span>) -
      added by <em>michael</em> <a class="timeline" href="/report/timeline?from=2013-01-02T15%3A37%3A37%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 15:37:37">2 years ago</a>.
  </dt>
          </dl>
          <p>
            Download all attachments as: <a rel="nofollow" href="/report/zip-attachment/ticket/745/">.zip</a>
          </p>
          
        </div>
    </div>

        <div>
          <div style="position: relative">
            <form id="prefs" method="get" action="/report/prefs" style="position: absolute; right: 0">
              <div id="trac-comments-order">
                <input type="radio" id="trac-comments-oldest" name="trac-comments-order" value="oldest" checked="checked" />
                <label for="trac-comments-oldest">Oldest first</label>
                <input type="radio" id="trac-comments-newest" name="trac-comments-order" value="newest" />
                <label for="trac-comments-newest">Newest first</label>
                <span id="trac-threaded-toggle" style="display: none">
                  <input type="radio" id="trac-comments-threaded" name="trac-comments-order" value="threaded" />
                  <label for="trac-comments-threaded">Threaded</label>
                </span>
              </div>
              <div>
                <input id="trac-comments-only-toggle" type="checkbox" />
                <label for="trac-comments-only-toggle">Comments only</label>
              </div>
            </form>
          </div>
          <h3 class="foldable">Change History <span class="trac-count">(22)</span></h3>
          <div id="changelog">
              <div class="change">
                
  <h3 class="change">
    <span class="threading">
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-07-03T12%3A19%3A49%2B02%3A00&amp;precision=second" title="See timeline at 07/03/12 12:19:49">3 years ago</a> by Bruno BRAGA &lt;bruno.braga@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-attachment">
      <strong class="trac-field-attachment">Attachment</strong>
        <a href="/report/attachment/ticket/745/i3log-2012-07-03-20-02-07.tar.gz"><em>i3log-2012-07-03-20-02-07.tar.gz</em></a><a href="/report/raw-attachment/ticket/745/i3log-2012-07-03-20-02-07.tar.gz" title="Download" class="trac-rawlink">​</a>
          added
    </li>
  </ul>

              </div>
              <div class="change" id="trac-change-1-1341953514160465">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:1" class="cnum">
    <a href="#comment:1">comment:1</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-07-10T22%3A51%3A54%2B02%3A00&amp;precision=second" title="See timeline at 07/10/12 22:51:54">3 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Checkgmail is a bad example, as it uses <tt>Gtk2::TrayIcon</tt>, which doesn’t actually use Gtk despite the name. It uses the "eggtrayicon" library, which apparently fails to implement the spec properly and doesn’t deal with tray managers coming and going. You can verify this using stalonetray instead of i3bar for example (I also xtraced it and read the code).<br />
</p>
<p>
I could reproduce the problem with xchat, too, though. Not sure if it’s the same problem throughout all your applications, so feel free to follow-up.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-2-1341953690104848">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:2" class="cnum">
    <a href="#comment:2">comment:2</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-07-10T22%3A54%3A50%2B02%3A00&amp;precision=second" title="See timeline at 07/10/12 22:54:50">3 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-resolution">
      <strong class="trac-field-resolution">Resolution</strong>
        set to <em>fixed</em>
    </li><li class="trac-field-status">
      <strong class="trac-field-status">Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      <p>
This should be fixed with commit 8a3574f301725ba48484c05408e35ecec27aad65. Feel free to re-open in case you got other test cases with which it still doesn’t work.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3-1342007518883705">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:3" class="cnum">
    <a href="#comment:3">comment:3</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-07-11T13%3A51%3A58%2B02%3A00&amp;precision=second" title="See timeline at 07/11/12 13:51:58">3 years ago</a> by Bruno BRAGA &lt;bruno.braga@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Michael, <br />
</p>
<p>
Thanks for the input. This corrected issues for Skype and Xchat. And, as you predicted, checkgmail is still failing.<br />
</p>
<p>
I can survive with that by simply restarting the application every time (exec-always).<br />
</p>
<p>
Cheers,<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4-1342595486167918">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:4" class="cnum">
    <a href="#comment:4">comment:4</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-07-18T09%3A11%3A26%2B02%3A00&amp;precision=second" title="See timeline at 07/18/12 09:11:26">3 years ago</a> by lkraav &lt;leho@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Also experiencing this, following. I'm running 4.2 stable, I wonder how well the patch applies on top of it (-&gt; Gentoo). I guess I can always clone the whole repo, too..<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5-1347611836622331">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:5" class="cnum">
    <a href="#comment:5">comment:5</a>
  </span>
          <span>follow-up:</span>
    <a href="#comment:6" class="follow-up">↓ 6</a>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-09-14T10%3A37%3A16%2B02%3A00&amp;precision=second" title="See timeline at 09/14/12 10:37:16">3 years ago</a> by lkraav
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I'm running now with 8a3574f301725ba48484c05408e35ecec27aad65 applied. But still every time I connect my HDMI plug and i3 runs through its udev reaction stuff, Skype and wpa_gui icons disappear 100% of the time. I usually do in-place restart, that makes all the icons come back. I'd vote for reopening this.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6-1347616743594714">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:6" class="cnum">
    <a href="#comment:6">comment:6</a>
  </span>
        in reply to:
    <a href="#comment:5">↑ 5</a>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-09-14T11%3A59%3A03%2B02%3A00&amp;precision=second" title="See timeline at 09/14/12 11:59:03">3 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Replying to <a class="ticket" href="/report/ticket/745#comment:5" title="Comment 5">lkraav</a>:<br />
</p>
<blockquote class="citation">
<p>
I'm running now with 8a3574f301725ba48484c05408e35ecec27aad65 applied. But still every time I connect my HDMI plug and i3 runs through its udev reaction stuff, Skype and wpa_gui icons disappear 100% of the time. I usually do in-place restart, that makes all the icons come back. I'd vote for reopening this.<br />
</p>
</blockquote>
<p>
Please run the latest git next version (22922a9e7094fd029a5d356bd48237dae3b5a435 as of now) instead of just applying some particular commit. Does the problem persist? Also, is it only Skype and wpa_gui? Are other tray icons unaffected?<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7-1348216859507326">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:7" class="cnum">
    <a href="#comment:7">comment:7</a>
  </span>
          <span>follow-up:</span>
    <a href="#comment:8" class="follow-up">↓ 8</a>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-09-21T10%3A40%3A59%2B02%3A00&amp;precision=second" title="See timeline at 09/21/12 10:40:59">3 years ago</a> by lkraav &lt;leho@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
That patch seemed to be independent enough to try. Either way, I'm now on 4.3. Problem still exists. Only thing I'm seeing in .xsession-errors is:<br />
</p>
<pre class="wiki">[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 05200e4d 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 024001f4 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 0121a2fb 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 05200eb7 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 024001ff 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 0121a378 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 05200ebf 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 02400205 
[i3bar/src/xcb.c:596] ERROR: PropertyNotify received for unknown window 0121a385
</pre><p>
Tray moves to my external monitor and loses some icons. Now I'm also seeing that even when restarting i3, Skype icon comes back, but wpa_gui icon stays missing. wpa_gui *is* running.<br />
</p>
<pre class="wiki">leho     12873  0.0  0.1  29752  6800 ?        S    Sep13   0:25 wpa_gui
</pre>
    </div>

              </div>
              <div class="change" id="trac-change-8-1348216956770135">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:8" class="cnum">
    <a href="#comment:8">comment:8</a>
  </span>
        in reply to:
    <a href="#comment:7">↑ 7</a>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-09-21T10%3A42%3A36%2B02%3A00&amp;precision=second" title="See timeline at 09/21/12 10:42:36">3 years ago</a> by lkraav &lt;leho@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Replying to <a class="ticket" href="/report/ticket/745#comment:7" title="Comment 7">lkraav &lt;leho@…&gt;</a>:<br />
</p>
<blockquote class="citation">
<p>
Tray moves to my external monitor and loses some icons. Now I'm also seeing that even when restarting i3, Skype icon comes back, but wpa_gui icon stays missing. wpa_gui *is* running.<br />
</p>
</blockquote>
<p>
Common denominator is both of these are Qt-based apps.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-9-1349026650726216">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:9" class="cnum">
    <a href="#comment:9">comment:9</a>
  </span>
          <span>follow-up:</span>
    <a href="#comment:10" class="follow-up">↓ 10</a>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-09-30T19%3A37%3A30%2B02%3A00&amp;precision=second" title="See timeline at 09/30/12 19:37:30">2 years ago</a> by lkraav &lt;leho@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Hi Michael<br />
</p>
<p>
Can you shoot an update on if you have any idea on what's going on here or is further information needed?<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-10-1349027521034292">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:10" class="cnum">
    <a href="#comment:10">comment:10</a>
  </span>
        in reply to:
    <a href="#comment:9">↑ 9</a>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2012-09-30T19%3A52%3A01%2B02%3A00&amp;precision=second" title="See timeline at 09/30/12 19:52:01">2 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Replying to <a class="ticket" href="/report/ticket/745#comment:9" title="Comment 9">lkraav &lt;leho@…&gt;</a>:<br />
</p>
<blockquote class="citation">
<p>
Hi Michael<br />
</p>
<p>
Can you shoot an update on if you have any idea on what's going on here or is further information needed?<br />
</p>
</blockquote>
<p>
I haven’t looked into it yet.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-11-1357043412481420">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:11" class="cnum">
    <a href="#comment:11">comment:11</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-01T13%3A30%3A12%2B01%3A00&amp;precision=second" title="See timeline at 01/01/13 13:30:12">2 years ago</a> by angus@…
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I am having this problem, running i3 4.4 on my netbook.<br />
</p>
<p>
If I start VLC or Skype, they put icons in the i3bar tray. When the xrandr outputs change (e.g if I plug in an external monitor, or if I use xrandr to change resolution or something), the applications keep running normally but their tray icons disappear. Restarting i3 with mod+shift+R makes the icons appear again.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-12-1357092992911143">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:12" class="cnum">
    <a href="#comment:12">comment:12</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T03%3A16%3A32%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 03:16:32">2 years ago</a> by angus@…
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Looks like a Qt bug, actually. VLC and Skype both use Qt.<br />
</p>
<p>
When the xrandr outputs change, i3bar kicks all the tray clients, expecting them to start the system tray protocol again. But it seems that Qt doesn't behave correctly.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-13-1357105568455101">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:13" class="cnum">
    <a href="#comment:13">comment:13</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T06%3A46%3A08%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 06:46:08">2 years ago</a> by lkraav &lt;leho@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
This is still an issue on qt-4.8.4<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-14-1357115668823913">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:14" class="cnum">
    <a href="#comment:14">comment:14</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T09%3A34%3A28%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 09:34:28">2 years ago</a> by angus@…
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
It looks like maybe Qt doesn't try to add system tray icons to the tray again unless it sees the previous tray window has been destroyed. (I'm looking at <a class="ext-link" href="http://qt.gitorious.org/qt/qt/blobs/4.8/src/gui/util/qsystemtrayicon_x11.cpp"><span class="icon">​</span>http://qt.gitorious.org/qt/qt/blobs/4.8/src/gui/util/qsystemtrayicon_x11.cpp</a> near line 129.)<br />
</p>
<p>
I don't have much experience with X11 or the system tray, so I don't really know what I'm doing, but I tried to make i3bar destroy and recreate the tray window every time the outputs are reconfigured. Here is a quick not-very-well-tested patch that seems to only sometimes work. I might investigate more later, but if not, hopefully at least people can understand what I was trying to do.<br />
</p>
<pre class="wiki">diff --git a/i3bar/src/xcb.c b/i3bar/src/xcb.c
index 3a8d8b9..cc1470f 100644
--- a/i3bar/src/xcb.c
+++ b/i3bar/src/xcb.c
@@ -52,6 +52,9 @@ xcb_window_t     xcb_root;
 /* This is needed for integration with libi3 */
 xcb_connection_t *conn;
 
+/* The window which holds the system tray atom selection */
+xcb_window_t selwin = XCB_NONE;
+
 /* The font we'll use */
 static i3Font font;
 
@@ -1006,8 +1009,17 @@ void init_tray(void) {
     xcb_intern_atom_reply_t *tray_reply;
     tray_cookie = xcb_intern_atom(xcb_connection, 0, strlen(atomname), atomname);
 
+    /* If we already have a tray, destroy it first */
+    if (selwin != XCB_NONE) {
+        i3_output *o_walk;
+        SLIST_FOREACH(o_walk, outputs, slist) {
+            kick_tray_clients(o_walk);
+        }
+        xcb_destroy_window(xcb_connection, selwin);
+    }
+
     /* tray support: we need a window to own the selection */
-    xcb_window_t selwin = xcb_generate_id(xcb_connection);
+    selwin = xcb_generate_id(xcb_connection);
     uint32_t selmask = XCB_CW_OVERRIDE_REDIRECT;
     uint32_t selval[] = { 1 };
     xcb_create_window(xcb_connection,
@@ -1223,7 +1235,6 @@ void realloc_sl_buffer(void) {
 void reconfig_windows(void) {
     uint32_t mask;
     uint32_t values[5];
-    static bool tray_configured = false;
 
     i3_output *walk;
     SLIST_FOREACH(walk, outputs, slist) {
@@ -1378,13 +1389,6 @@ void reconfig_windows(void) {
                 (!config.hide_on_modifier &amp;&amp; xcb_request_failed(map_cookie, "Could not map window"))) {
                 exit(EXIT_FAILURE);
             }
-
-            if (!tray_configured &amp;&amp;
-                (!config.tray_output ||
-                 strcasecmp("none", config.tray_output) != 0)) {
-                init_tray();
-                tray_configured = true;
-            }
         } else {
             /* We already have a bar, so we just reconfigure it */
             mask = XCB_CONFIG_WINDOW_X |
@@ -1423,6 +1427,10 @@ void reconfig_windows(void) {
             }
         }
     }
+
+    if (!config.tray_output || strcasecmp("none", config.tray_output) != 0) {
+        init_tray();
+    }
 }
 
 /*
</pre>
    </div>

              </div>
              <div class="change" id="trac-change-15-1357137431016531">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:15" class="cnum">
    <a href="#comment:15">comment:15</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T15%3A37%3A11%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 15:37:11">2 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-resolution">
      <strong class="trac-field-resolution">Resolution</strong>
        <em>fixed</em> deleted
    </li><li class="trac-field-status">
      <strong class="trac-field-status">Status</strong>
        changed from <em>closed</em> to <em>new</em>
    </li>
  </ul>
    <div class="comment searchable">
      <p>
After a few hours of debugging, I think that i3bar should send a faked <a class="forbidden wiki" title="no permission to view this wiki page">DestroyNotify</a> (makes Qt pick up the tray changes) followed by a MANAGER <a class="forbidden wiki" title="no permission to view this wiki page">ClientMessage</a> (makes GTK pick up the tray after the <a class="forbidden wiki" title="no permission to view this wiki page">DestroyNotify</a>).<br />
</p>
<p>
Find attached a patch which does that. It works for me with nm-applet and VLC.<br />
</p>
<p>
Please tell me how it works for you, then I’ll merge it.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-16-1357137435477359">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:16" class="cnum">
    <a href="#comment:16">comment:16</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T15%3A37%3A15%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 15:37:15">2 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-status">
      <strong class="trac-field-status">Status</strong>
        changed from <em>new</em> to <em>infoneeded_new</em>
    </li>
  </ul>

              </div>
              <div class="change">
                
  <h3 class="change">
    <span class="threading">
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T15%3A37%3A37%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 15:37:37">2 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-attachment">
      <strong class="trac-field-attachment">Attachment</strong>
        <a href="/report/attachment/ticket/745/745.patch"><em>745.patch</em></a><a href="/report/raw-attachment/ticket/745/745.patch" title="Download" class="trac-rawlink">​</a>
          added
    </li>
  </ul>

              </div>
              <div class="change" id="trac-change-17-1357138094828608">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:17" class="cnum">
    <a href="#comment:17">comment:17</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T15%3A48%3A14%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 15:48:14">2 years ago</a> by lkraav &lt;leho@…&gt;
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Nice job @michael, my preliminary testing indicates the patch works for everything: qt, gtk, wine apps. I guess it'd make sense to let it go through some days of real world work time before signing off.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-18-1357147286667961">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:18" class="cnum">
    <a href="#comment:18">comment:18</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T18%3A21%3A26%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 18:21:26">2 years ago</a> by michael
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Thanks for the feedback.<br />
</p>
<p>
By the way, since I have just looked into this:<br />
</p>
<p>
Java (starting with OpenJDK ≥ 7) correctly realizes that the tray manager has gone away and passes that on via its API. This means it will send a <a class="forbidden wiki" title="no permission to view this wiki page">PropertyChangeEvent</a> with which the programmer can notice that the tray icons have been deleted and should be re-added.<br />
</p>
<p>
It seems like JDownloader and others don’t do that and therefore have a somewhat buggy system tray behavior. If someone wants to fix it and bring that fix upstream, I’d welcome that.<br />
</p>
<p>
Here is my proof of concept:<br />
</p>
<pre class="wiki">import java.awt.AWTException;
import java.awt.Image;
import java.awt.SystemTray;
import java.awt.Toolkit;
import java.awt.TrayIcon;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;

class MiniTray {
    public static void main(String[] args) {
        final SystemTray systemTray = SystemTray.getSystemTray();

        Image i = Toolkit.getDefaultToolkit().getImage(
                "/usr/share/icons/xmonad.png");
        final TrayIcon trayIcon = new TrayIcon(i, "Tray Demo", null);

        PropertyChangeListener pcl;
        pcl = new PropertyChangeListener() {
            @Override   
            public void propertyChange(PropertyChangeEvent pce) {
                TrayIcon[] tia = (TrayIcon[]) pce.getNewValue();
                if (tia != null &amp;&amp; tia.length == 0) {
                    try {               
                        systemTray.add(trayIcon);
                    } catch (AWTException e) {
                        // TODO Auto-generated catch block
                        e.printStackTrace();    
                    }                   
                }               
            }           
        };      
        systemTray.addPropertyChangeListener("trayIcons", pcl);

        try {   
            systemTray.add(trayIcon);
        } catch (AWTException e) {
            System.err.println("could not add");
        }       

        while (true) {
            try {       
                Thread.sleep(1000);
            } catch (InterruptedException e) {
            }           
        }       
    }   
}
</pre>
    </div>

              </div>
              <div class="change" id="trac-change-19-1357164940145448">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:19" class="cnum">
    <a href="#comment:19">comment:19</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T23%3A15%3A40%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 23:15:40">2 years ago</a> by Michael Stapelberg
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-resolution">
      <strong class="trac-field-resolution">Resolution</strong>
        set to <em>fixed</em>
    </li><li class="trac-field-status">
      <strong class="trac-field-status">Status</strong>
        changed from <em>infoneeded_new</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      <p>
This ticket was fixed in commit <a class="ext-link" href="http://c.i3wm.org/e9503a1f"><span class="icon">​</span>http://c.i3wm.org/e9503a1f</a>:<br />
</p>
<pre class="wiki">i3bar: fake DestroyNotify and send MANAGER ClientMessages to fix tray restarts

fixes #745

</pre>
    </div>

              </div>
              <div class="change" id="trac-change-20-1357166814566502">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:20" class="cnum">
    <a href="#comment:20">comment:20</a>
  </span>
    </span>
        Changed <a class="timeline" href="/report/timeline?from=2013-01-02T23%3A46%3A54%2B01%3A00&amp;precision=second" title="See timeline at 01/02/13 23:46:54">2 years ago</a> by angus@…
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Seems to work for me too. Thanks.<br />
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/report/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/report/ticket/745?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/report/ticket/745?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/report/ticket/745?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="/report/chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="/report/about"><strong>Trac 1.0.2</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right"><a href="http://i3wm.org/">http://i3wm.org</a></p>
    </div>
  </body>
</html>